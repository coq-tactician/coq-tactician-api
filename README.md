# Reinforcement learning for Tactician

## Assumptions

The recommended `opam` version is `>= 2.1.0`. Other versions might work as well, but you may have to install some dependencies manually.

Notice: the installation depends on ocaml version 4.11.2 that is in conflict with glibc version >= 2.34
and therefore fails on Ubuntu 21.10. 

On Ubuntu 20.04 the packages installed by the following are required:

```
sudo apt-get --yes install graphviz capnproto libcapnp-dev pkg-config libev-dev
```

## Installation

To install from developer git+ssh repository under new opam switch `tact` run

```
opam switch create tact --empty &&  eval $(opam env --switch=tact)
opam pin coq-tactician-reinforce git+ssh://git@github.com/coq-tactician/coq-tactician-reinforce.git --yes
```

## Extra repositories 
For development work you may need to add repositories of `https://github.com/coq/opam-coq-archive`

``` 
opam repo add coq-released https://coq.inria.fr/opam/released     # packages for officially released versions of Coq libraries and Coq extensions
opam repo add coq-extra-dev https://coq.inria.fr/opam/extra-dev   # packages for development versions of Coq
opam repo add coq-core-dev https://coq.inria.fr/opam/core-dev     # packages for development versions of Coq libraries and Coq extensions
opam repo add custom-archive https://github.com/LasseBlaauwbroek/custom-archive.git # for Lasse's bugfixes of Coq 
```




## For developers
To allow one-liner remote pinning as above, after an update to the submodule `coq-tactician` commit, execute:

```
git add coq-tactician
make
git commit
```

The command `make` records appropriately the submodule's COMMIT_ID in the `pin depends` opam command argument to point correctly `git+https://github.com/coq-tactician/coq-tactician.git#COMMIT_ID` 



## Containers

To verify installation in a controlled enviroment we provide Dockerfile script. The Dockerfile can be used with `docker` or `podman`. To build the image, run from the directory containing the Dockerfile
```
podman build -t tac:test . 
```
We recommend using podman in rootless mode as there are certain unresolved limitation of bubblewrap / user namespaces with docker container.  

Notice: as of `podman 3.3.1` and `opam 2.0.5` sometimes race conditions have been detected with building on multicore. Updating podman and/or opam might fix the issue.

## Available Commands

These commands will create a graph of some object, and write it to `graph.pdf` (if `graphviz` is available).

The following commands are always available:
```
[Full] [LGraph | Graph | DAG] Ident identifier.
[Full] [LGraph | Graph | DAG] Term term.
```
Normally, the commands print a non-transitive graph. The `[Full]` modifier changes this so that the full transitive graph of definitions is added.

Additionally, in proof mode, these commands are available:
```
[Full] [LGraph | Graph | DAG] Proof.
```

Options that modify the graphs generated by the commands above are
```
[Set | Unset] Tactician Reinforce Visualize Ordered.
[Set | Unset] Tactician Reinforce Visualize Labels.
```

## Reinforcement learning

Finally, the command `Reinforce.` will initiate a reinforcement session. An example of this is available in
[tests/ReinforceTest.v](theories/ReinforceTest.v).
To do this, you need to have a python client running. An example is available in pip package `pytact` that you can install 
with 
```
pip install git+ssh://git@github.com/coq-tactician/coq-tactician-reinforce.git
```

To see how it works, run 
```
pytact-test
```
optionally `--file` option to point to a source Coq `.v` file. 
Also with `--interactive` option the innteractive shell appears where you can
manually interact with the environment. Whenever a tactic is executed,
the resulting proof state if visualized in the file
`python_graph.pdf`.
